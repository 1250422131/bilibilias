# This file was generated using Kotlin DSL (.github/workflows/src.main.kts).
# If you want to modify the workflow, please change the Kotlin file and regenerate this YAML file.
# Generated with https://github.com/typesafegithub/github-workflows-kt

name: 'Build'
on:
  push:
    branches:
    - 'kmp'
concurrency:
  group: 'build-${{ github.ref }}'
  cancel-in-progress: true
jobs:
  BuildAndUpload:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 50
    steps:
    - id: 'step-0'
      name: 'Checkout'
      uses: 'actions/checkout@v4'
    - id: 'step-1'
      name: 'Copy CI gradle.properties'
      run: 'mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties'
    - id: 'step-2'
      name: 'Setup Java'
      uses: 'actions/setup-java@v4'
      with:
        java-version: '21'
        distribution: 'zulu'
    - id: 'step-3'
      name: 'Setup Gradle'
      uses: 'gradle/actions/setup-gradle@v4'
      with:
        cache-disabled: 'true'
    - id: 'step-4'
      name: 'Check build-logic'
      run: './gradlew :build-logic:convention:check'
    - id: 'step-5'
      name: 'Apk Sign'
      run: |-
        cp "$GITHUB_WORKSPACE/.github/workflows/bilibilias.jks" "$GITHUB_WORKSPACE/bilibilias.jks"
        sed "signing_release_storeFileFromRoot=./bilibilias.jks" $GITHUB_WORKSPACE/gradle.properties -i
        sed "signing_release_keyAlias=bilibilias"                $GITHUB_WORKSPACE/gradle.properties -i
        sed "signing_release_storePassword=bilibilias"           $GITHUB_WORKSPACE/gradle.properties -i
        sed "signing_release_storePassword=bilibilias"           $GITHUB_WORKSPACE/gradle.properties -i
    - id: 'step-6'
      name: 'Build all build type and flavor permutations'
      run: './gradlew :app:assemble'
    - id: 'step-7'
      name: 'Upload build outputs (APKs)'
      uses: 'actions/upload-artifact@v4'
      with:
        name: 'APKs'
        path: '**/build/outputs/apk/**/*.apk'
