# This file was generated using Kotlin DSL (.github/workflows/src.main.kts).
# If you want to modify the workflow, please change the Kotlin file and regenerate this YAML file.
# Generated with https://github.com/typesafegithub/github-workflows-kt

name: 'GitHub Release with APKs'
on:
  workflow_dispatch: { }
  push:
    tags:
      - 'v*'
permissions:
  actions: 'write'
  contents: 'write'
jobs:
  BuildAndUpload:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 120
    steps:
      - id: 'step-0'
        name: 'Checkout'
        uses: 'actions/checkout@v4'
      - id: 'step-1'
        name: 'Copy CI gradle.properties'
        run: 'mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties'
      - id: 'step-2'
        name: 'Setup Java'
        uses: 'actions/setup-java@v4'
        with:
          java-version: '21'
          distribution: 'zulu'
      - id: 'step-3'
        name: 'Setup Gradle'
        uses: 'gradle/actions/setup-gradle@v4'
        with:
          cache-encryption-key: '${{ secrets.GRADLE_ENCRYPTION_KEY }}'
          build-scan-publish: 'true'
          build-scan-terms-of-use-url: 'https://gradle.com/terms-of-service'
          build-scan-terms-of-use-agree: 'yes'
      - id: 'step-4'
        name: 'Apk Sign'
        run: |-
          cp $GITHUB_WORKSPACE/.github/workflows/bilibilias.jks    $GITHUB_WORKSPACE/bilibilias.jks
          echo -e '\n'                                              >> $GITHUB_WORKSPACE/gradle.properties
          echo 'signing_release_storeFileFromRoot=./bilibilias.jks' >> $GITHUB_WORKSPACE/gradle.properties
          echo 'signing_release_keyAlias=bilibilias'                >> $GITHUB_WORKSPACE/gradle.properties
          echo 'signing_release_storePassword=bilibilias'           >> $GITHUB_WORKSPACE/gradle.properties
          echo 'signing_release_keyPassword=bilibilias'             >> $GITHUB_WORKSPACE/gradle.properties
      - id: 'step-5'
        name: 'Build release variant'
        run: './gradlew :app:assembleRelease'
      - id: 'step-6'
        name: 'Get Tag'
        uses: 'dawidd6/action-get-tag@v1'
      - id: 'step-7'
        uses: 'bhowell2/github-substring-action@v1.0.0'
        with:
          value: '${{ steps.step-6.outputs.tag }}'
          index_of_str: 'v'
          default_return_value: '${{ steps.step-6.outputs.tag }}'
      - id: 'step-8'
        name: 'Generate Release Notes'
        run: |-
          # Specify the file path
          FILE_PATH="ci-helper/release-template.md"
          
          # Read the file content
          file_content=$(cat "$FILE_PATH")
          
          modified_content="$file_content"
          # Replace 'string_to_find' with 'string_to_replace_with' in the content
          modified_content="${modified_content//\$GIT_TAG/${{ steps.step-6.outputs.tag }}}"
          modified_content="${modified_content//\$TAG_VERSION/${{ steps.step-7.outputs.substring }}}"
          
          # Output the result as a step output
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$modified_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - id: 'step-9'
        name: 'Create Release'
        uses: 'softprops/action-gh-release@v2'
        with:
          body: '${{ steps.step-8.outputs.result }}'
          name: '${{ steps.step-7.outputs.substring }}'
          tag_name: '${{ steps.step-6.outputs.tag }}'
          draft: 'true'
          prerelease: '${{ contains(steps.step-6.outputs.tag, ''-'') }}'
          files: 'app/build/outputs/apk/release/app-release.apk'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
